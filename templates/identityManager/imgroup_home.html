{% extends "projectCore/sb_admin2_index_template.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ file }}{% endblock %}

{% block page_content %}
    <div class="container-fluid">
        <div class="row">

{#            {% include "identityManager/modal/addIdentityObjectModal.html" %}#}

            {% csrf_token %}

                {# Nesne listelerini goster#}
                <div class="col-lg-12">

                    <div class="card mt-4 shadow">
                        <div class="card-header bg-gradient-primary text-gray-100">Group: {{ imgroup.name }}</div>
                        <div class="card-body">
                            <p>{{ imgroup.description }}</p>

                            <div class="row">
                                <div class="col-md-3"><span
                                        class="label label-primary">{% if imgroup.memberUsers.count == 0 %} No {% else %}{{ imgroup.memberUsers.count }}{% endif %} Member Users</span></div>
                                <div class="col-md-3"><span
                                        class="label label-primary">{% if imgroup.memberGroups.count == 0 %} No {% else %}{{ imgroup.memberGroups.count }}{% endif %} Member Groups</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4 border-left-primary shadow">
                        <div class="card-header">

                                Member Users
{#                                <div class="pull-right">#}
{#                                </div>#}

                        </div>
                        <div class="card-body">
                            <table id="wbdap_imgroup_member_user_list_table" class="display table table-hover table-striped">
                                <thead>
                                <tr>
{#                                    <th></th>#}
                                    <th>Username</th>
                                    <th>Name</th>
                                    <th>Surname</th>
                                    <th>Email</th>
                                    <th>Superuser</th>
                                    <th>Operations</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>

                    <div class="card mt-3 border-left-primary shadow">
                        <div class="card-header">
                                Member Groups
                        </div>
                        <div class="card-body">
                            <table id="wbdap_imgroup_member_group_list_table" class="display table table-hover table-striped">
                                <thead>
                                <tr>
{#                                    <th></th>#}
                                    <th>Group Name</th>
                                    <th>Description</th>
                                    <th>Operations</th>
                                </tr>
                                </thead>
                            </table>

                        </div>
                    </div>
                </div>

        </div>
    </div>
{% endblock %}





{% block body__jscript %}
    {{ block.super }}
    <script src="{% static "identityManager/jscript/identityManager.js" %}"></script>

    <script>
        $(document).ready(function () {
            var csrftoken = $("input[name='csrfmiddlewaretoken']").attr('value');

            function split(val) {
                return val.split(/,\s*/);
            }

            function extractLast(term) {
                return split(term).pop();
            }

            var imgroup_memberuser_editor = new $.fn.dataTable.Editor({
                ajax: {
                    create: {
                        type: 'PUT',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/memberuser/add/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        contentType: 'application/json',
                        data: function (d) {
                            var keys = Object.keys(d.data);
                            ndata = JSON.stringify(d.data[keys[0]]);
                            return ndata;
                        },
                        success: function (d) {
                            console.log('success');
                            console.log(d);
                            imgroup_users_table.row.add(d).draw(false)
                        }
                    },
                    edit: {
                        type: 'PUT',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/memberuser/_id_/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        contentType: 'application/json',
                        data: function (d) {
                            console.log(d)
                            var row_id = Object.keys(d.data)
                            var jdata = d.data[row_id]

                            var jdata_keys = Object.keys(jdata);
                            $.each(jdata_keys, function (k, v) {
                                if (v.startsWith('is_')) {
                                    if (jdata[v] === "") {
                                        // alert(v+" is empty valued")
                                        delete jdata[v];
                                        jdata[v] = 'false';
                                    }
                                }
                            })

                            ndata = JSON.stringify(jdata);
                            return ndata;
                        },

                    },
                    remove: {
                        type: 'DELETE',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/memberuser/_id_/remove/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }, contentType: 'application/json',
                        data: function (d) {
                            var keys = Object.keys(d.data);
                            ndata = JSON.stringify(d.data[keys[0]]);
                            return ndata;
                        },
                    }
                },
                table: "#wbdap_imgroup_member_user_list_table",
                idSrc: 'id',
                {#Username alani disinda hicbir field icermeyen create ekraninda , username alani bir #}
                {#autocomplete fielddir. Asagidaki kod blogu ile bu blok jquery istegi ile doldurulmaktadir.#}
                fields: [{
                    id: "username",
                    label: "Username:",
                    name: "username",
                    type: "autoComplete",
                    autoFocus: true,

                    opts: {
                        {#source: '/identityManager/user/autocompleteUsers',#}
                        minLength: 0,
                        autoFocus: false,
                        autocomplete: true,
                        source: function (request, response) {
                            {#Asagidaki ajax kodu ile bir autocomplete istegi yapilmakta. Gelen sonuclar#}
                            {#bir select alani icinde gosterilmektedir.#}
                            $.ajax({
                                url: "/identityManager/imuser/autocompleteUsers",
                                dataType: "jsonp",
                                data: {
                                    term: extractLast(request.term)
                                },
                                {#Alma islemi basarili ise bu block calistirilir#}
                                success: function (data) {
                                    console.log($.map(data, function (value, key) {
                                        console.log("Field successfully retrieved:"+value.username);
                                        return {
                                            value: value.username
                                        }
                                    }));
                                    {#Asagidaki blok alinan veriler ile kullaniciya gosterilen alanin nasil render #}
                                    {#edilecegini gostermektedir.#}
                                    response($.map(data, function (value, key) {
                                        console.log(value.username);
                                        return {
                                            label: value.username + ":" + value.first_name + " " + value.last_name,
                                            value: value.username
                                        }
                                    }));
                                }
                            });
                        },
                        create: function () {
                            $(this).data('ui-autocomplete')._renderMenu = function (ul, items) {
                                var that = this;
                                $.each(items, function (index, item) {
                                    that._renderItemData(ul, item);
                                });
                                $(ul).find("li:odd").addClass("odd_auto_complete");
                            }

                        },
                        focus: function () {
                            // prevent value inserted on focus
                            return false;
                        },
                        appendTo: "#DTE",
                        // Asagidaki kisim istegin icerigi ile ilgili kisim; her yazilan karakter burada
                        // sorgu olarak karsidaki sunucuya gonderilecek.
                        // donen cevap success kisminda
                        select: function (event, ui) {
                            console.log("inputun mevcut degeri: "+this.value)
                            var terms = split(this.value);
                            // remove the current input
                            terms.pop();

                            // add the selected item
                            terms.push(ui.item.value);
                            // add placeholder to get the comma-and-space at the end
                            terms.push("");
                            this.value = terms.join(", ");
                            // Geri donecek olan input text sadece virguller ile ayrilmis bir string'dir.
                            // inputu alan noktada bu string virgulleri kullanarak bir array haline donusturmek
                            // gerekir.
                            console.log(this.value)
                            return false;
                        }
                    }
                }, {
                    label: "Staus:",
                    type: "checkbox",
                    name: "active",
                    unselectedValue: "false",
                    options: [
                        {label: "Active", value: "true"}
                    ],
                }
                ]
            });


            var imgroup_users_table= $('#wbdap_imgroup_member_user_list_table').DataTable({
                "scrollY": "500px",
                "scrollCollapse": true,
                "dom": 'Bfrtip',
                "paging": true,
                "select": true,
                "info": false,
                "ordering": true,
                "processing": true,
                "serverSide": true,
                "responsive": true,
                {#"order": [[ 1, 'asc' ], [ 2, 'asc' ]],#}
                "ajax": {
                    url: "/api/v1/identityManager/imgroup/{{ imgroup.id }}/memberuser/?format=json",
                    dataSrc: 'results',
                    data: function (d) {
                        var keys = Object.keys(d);

                        var offset = d["start"];
                        var limit = d["length"];
                        var search = d["search"];
                        var ordering = d["order"][0]["column"];
                        var order_val = d.columns[ordering]['data'];

                        d["offset"] = offset;
                        d["limit"] = limit;
                        d["order"][0]["column"] = order_val;
                        delete d["start"];
                        delete d["length"];
                    },
                    dataFilter: function (d) {
                        var json = jQuery.parseJSON(d);
                        json.recordsTotal = json.count;
                        json.recordsFiltered = json.count;
                        json.data = json.results;
                        console.log(json.data);
                        return JSON.stringify(json); // return JSON string
                    }
                },
                "columns": [
                    {#{#}
                    {#    data: null,#}
                    {#    defaultContent: '',#}
                    {#    className: 'select-checkbox not_editable',#}
                    {#    orderable: false#}
//                    {#},#}
                    {"data": "username", orderData: 1, targets: 1},
                    {"data": "first_name", orderData: 1, targets: 1},
                    {"data": "last_name", orderData: 1, targets: 1},
                    {"data": "email", orderData: 2, targets: 2},
                    {
                        "data": function (row, type, val, meta) {
                            if (row.is_superuser) {
                                return "Superuser"
                            } else {
                                return "False"
                            }
                        }
                    },
                    {
                        "data": null,
                        "render": function (data, type, row, meta) {
                            return '<a href="/identityManager/profile/' + data.id + '/">User Data</a>';
                        },

                        orderable: false
                    },
                ],
                select: true,
                buttons: [
                    {#{extend: "create", editor: imgroup_memberuser_editor},#}
                    {
                        extend: "create",
                        text: "Add User",
                        {#action: function (e, node, config) {#}
                        {#Assagidaki sati calisiyor, ancak standart create formunu  kullanmak daha kolay#}
                        {#$('#memberUserAddModal').modal('show')#}
                        // {#},#}
                        {#formButtons: [#}
                        {#    {#}
                        {#        label: 'Cancel',#}
                        {#        fn: function () {#}
                        {#            this.close();#}
                        {#        }#}
                        {#    },#}
                        {#    'Create new row'#}
                        {#],#}
                        formMessage: 'Add new user to group.',
                        formTitle: '<b>Add user</b>',
                        editor: imgroup_memberuser_editor
                    },

                    {#{extend: "edit", editor: imgroup_memberuser_editor},#}
                    {extend: "remove", text: "Remove User", editor: imgroup_memberuser_editor}
                ]
            });
            {#----------------------------------------------------------------------#}

            var imgroup_membergroup_editor = new $.fn.dataTable.Editor({
                ajax: {
                    create: {
                        type: 'PUT',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/membergroup/add/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        contentType: 'application/json',
                        data: function (d) {
                            var keys = Object.keys(d.data);
                            ndata = JSON.stringify(d.data[keys[0]]);
                            return ndata;
                        },
                        success: function (d) {
                            console.log('ajax query succeeded');
                            console.log(d);
                            imgroup_groups_table.row.add(d).draw(false)
                        }
                    },
                    edit: {
                        type: 'PUT',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/membergroup/_id_/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        contentType: 'application/json',
                        data: function (d) {
                            console.log(d)
                            var row_id = Object.keys(d.data)
                            var jdata = d.data[row_id]

                            var jdata_keys = Object.keys(jdata);
                            $.each(jdata_keys, function (k, v) {
                                if (v.startsWith('is_')) {
                                    if (jdata[v] === "") {
                                        // alert(v+" is empty valued")
                                        delete jdata[v];
                                        jdata[v] = 'false';
                                    }
                                }
                            })

                            ndata = JSON.stringify(jdata);
                            return ndata;
                        },

                    },
                    remove: {
                        type: 'DELETE',
                        url: '/api/v1/identityManager/imgroup/{{ imgroup.id }}/membergroup/_id_/remove/',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }, contentType: 'application/json',
                        data: function (d) {
                            var keys = Object.keys(d.data);
                            ndata = JSON.stringify(d.data[keys[0]]);
                            return ndata;
                        },
                    }
                },
                table: "#wbdap_imgroup_member_group_list_table",
                idSrc: 'id',
                fields: [{
                    id: "name",
                    label: "Name:",
                    name: "name",
                    type: "autoComplete",
                    opts: {

                        minLength: 0,
                        autoFocus: false,
                        autocomplete: true,
                        source: function (request, response) {
                            $.ajax({
                                url: "/identityManager/imgroup/autocompleteGroups",
                                dataType: "jsonp",
                                data: {
                                    term: extractLast(request.term)
                                },
                                success: function (data) {
                                    console.log(data)
                                    response($.map(data, function (value, key) {

                                        return {
                                            label: value.name+": "+value.description,
                                            value: value.name
                                        }
                                    }));
                                }
                            });
                        },
                        create: function () {
                            $(this).data('ui-autocomplete')._renderMenu = function (ul, items) {
                                var that = this;
                                $.each(items, function (index, item) {
                                    that._renderItemData(ul, item);
                                });
                                $(ul).find("li:odd").addClass("odd_auto_complete");
                            }

                        },

                        focus: function () {
                            // prevent value inserted on focus
                            return false;
                        },
                        appendTo: "#DTE",
                        // Asagidaki kisim istegin icerigi ile ilgili kisim; donen cevap success kisminda
                        select: function (event, ui) {
                            var terms = split(this.value);
                            // remove the current input
                            terms.pop();

                            // add the selected item
                            terms.push(ui.item.value);
                            // add placeholder to get the comma-and-space at the end
                            terms.push("");
                            this.value = terms.join(", ");
                            return false;
                        }
                    }
                }
                ]
            });

            var imgroup_groups_table= $('#wbdap_imgroup_member_group_list_table').DataTable({
                "scrollY": "500px",
                "scrollCollapse": true,
                "dom": 'Bfrtip',
                "paging": true,
                "select": true,
                "info": false,
                "ordering": true,
                "processing": true,
                "serverSide": true,
                "responsive": true,
                {#"order": [[ 1, 'asc' ], [ 2, 'asc' ]],#}
                "ajax": {
                    url: "/api/v1/identityManager/imgroup/{{ imgroup.id }}/membergroup/?format=json",
                    {#Donen json icindeki hangi alandan verileri alacagimizi gosterir, DRF web arayuzunden kontrol edilebilir#}
                    dataSrc: 'results',

                   {#Eger donen veri uzerinde oynamak ve degisiklik yapmak gereikse bu asagidaki gibi yapilabilir.#}
                   {# Bunun disinda sadece ustteki tek satir dataSrc: 'results' yeterlidir.#}
                   {# Asagidaki kisim aslinda sadece DRF tarafinda filtreleme yapabilmek amaci ile kullanilabilmektedir#}
                    data: function (d) {
                        var keys = Object.keys(d);

                        var offset = d["start"];
                        var limit = d["length"];
                        var search = d["search"];
                        var ordering = d["order"][0]["column"];
                        var order_val = d.columns[ordering]['data'];

                        d["offset"] = offset;
                        d["limit"] = limit;
                        d["order"][0]["column"] = order_val;
                        delete d["start"];
                        delete d["length"];
                    },
                    dataFilter: function (d) {
                        var json = jQuery.parseJSON(d);
                        console.log(JSON.stringify(json));
                        json.recordsTotal = json.count;
                        json.recordsFiltered = json.count;
                        json.data = json.results;
                        console.log(JSON.stringify(json));
                        return JSON.stringify(json); // return JSON string
                    }
                },
                "columns": [
                    {#{#}
                    {#    data: null,#}
                    {#    defaultContent: '',#}
                    {#    className: 'select-checkbox not_editable',#}
                    {#    orderable: false#}
//                    {#},#}
                    {data: "name", orderData: 1, targets: 1},
                    {data: "description", orderData: 2, targets: 1},
                    {
                        {#data parametresi asagida herhangi bir json alanina isaret etmedigi icin verinin#}
                        {#tamamini icermekte, bu yuzden belli bir alana erismek icin json icindeki data.field#}
                        {#kullanilabilir. Orn: asagida data id kullanilmaktadir. Eger jsonda bir alana baglanmis#}
                        {#data kullansaydik, dogrudan data parametresi data.id yerine kullanilabilirdi.#}
                        data: null,
                        "render": function (data, type, row, meta) {
                            console.log("data in data :"+data.id);
                            return '<a href="/identityManager/imgroup/' + data.id + '/">Subgroup Home</a>';
                        },
                        orderable: false
                    },
                ],
                select: true,
                buttons: [
                    {
                        extend: "create",
                        text: "Add Group",
                        editor: imgroup_membergroup_editor,
                        className: "btn btn-primary",
                        formMessage: 'Add new group to group.',
                        formTitle: '<b>Add Group</b>',
                    },
                    {extend: "remove", text: "Remove Group", editor: imgroup_membergroup_editor}
                ]
            });

        });


    </script>
{##}
{##}
{#    <script>#}
{#        $(function () {#}
{##}
{#            function split(val) {#}
{#                return val.split(/,\s*/);#}
{#            }#}
{##}
{#            function extractLast(term) {#}
{#                return split(term).pop();#}
{#            }#}
{##}
{##}
{#            $("#users")#}
{#            // don't navigate away from the field on tab when selecting an item#}
{#                .on("keydown", function (event) {#}
{#                    if (event.keyCode === $.ui.keyCode.TAB &&#}
{#                        $(this).autocomplete("instance").menu.active) {#}
{#                        event.preventDefault();#}
{#                    }#}
{#                })#}
{#                .autocomplete({#}
{#                    minLength: 0,#}
                    {#                        source: function (request, response) {#}
                    {#                            // delegate back to autocomplete, but extract the last term#}
                    {#                            response($.ui.autocomplete.filter(#}
                    {#                                    availableTags, extractLast(request.term)));#}
                    {#                        },#}
{#                    source: function (request, response) {#}
{#                        $.ajax({#}
{#                            url: "/identityManager/imuser/autocompleteUsers",#}
{#                            dataType: "jsonp",#}
{#                            data: {#}
{#                                term: extractLast(request.term)#}
{#                            },#}
{#                            success: function (data) {#}
{#                                console.log($.map(data, function (value, key) {#}
{#                                    console.log(value.username);#}
{#                                    return {#}
{#                                        value: value.username#}
{#                                    }#}
{#                                }));#}
{#                                response($.map(data, function (value, key) {#}
{#                                    console.log(value.username);#}
{#                                    return {#}
{#                                        label: value.username,#}
{#                                        value: value.username#}
{#                                    }#}
{#                                }));#}
{#                            }#}
{#                        });#}
{#                    },#}
{#                    focus: function () {#}
{#                        // prevent value inserted on focus#}
{#                        return false;#}
{#                    },#}
{#                    appendTo: "#memberUserAddModal",#}
{#                    // Asagidaki kisim istegin icerigi ile ilgili kisim; donen cevap success kisminda#}
{#                    select: function (event, ui) {#}
{#                        var terms = split(this.value);#}
{##}
{#                        // remove the current input#}
{#                        terms.pop();#}
{##}
{#                        // add the selected item#}
{#                        terms.push(ui.item.value);#}
{#                        // add placeholder to get the comma-and-space at the end#}
{#                        terms.push("");#}
{#                        this.value = terms.join(", ");#}
{#                        return false;#}
{#                    }#}
{#                });#}
{##}
{#            $("#groups")#}
{#            // don't navigate away from the field on tab when selecting an item#}
{#                .on("keydown", function (event) {#}
{#                    if (event.keyCode === $.ui.keyCode.TAB &&#}
{#                        $(this).autocomplete("instance").menu.active) {#}
{#                        event.preventDefault();#}
{#                    }#}
{#                })#}
{#                .autocomplete({#}
{#                    minLength: 0,#}
                    {#                        source: function (request, response) {#}
                    {#                            // delegate back to autocomplete, but extract the last term#}
                    {#                            response($.ui.autocomplete.filter(#}
                    {#                                    availableTags, extractLast(request.term)));#}
                    {#                        },#}
{#                    source: function (request, response) {#}
{#                        $.ajax({#}
{#                            url: "/identityManager/imgroup/autocompleteGroups",#}
{#                            dataType: "jsonp",#}
{#                            data: {#}
{#                                term: extractLast(request.term)#}
{#                            },#}
{#                            success: function (data) {#}
{#                                response(data);#}
{#                            }#}
{#                        });#}
{#                    },#}
{#                    focus: function () {#}
{#                        // prevent value inserted on focus#}
{#                        return false;#}
{#                    },#}
{#                    appendTo: "#memberGroupAddModal",#}
{#                    select: function (event, ui) {#}
{#                        var terms = split(this.value);#}
{##}
{#                        // remove the current input#}
{#                        terms.pop();#}
{#                        // add the selected item#}
{#                        terms.push(ui.item.value);#}
{#                        // add placeholder to get the comma-and-space at the end#}
{#                        terms.push("");#}
{#                        this.value = terms.join(", ");#}
{#                        return false;#}
{#                    }#}
{#                });#}
{##}
{##}
{#        });#}
{#    </script>#}

{% endblock %}
